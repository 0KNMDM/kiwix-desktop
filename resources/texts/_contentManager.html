<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html>
<head>
<script src="qrc:///js/vue.js"></script>
<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script type="text/javascript">
const units = ['bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
function niceBytes(x){
  var unitIndex = 0;
  var n = parseInt(x, 10) || 0;
  while(n >= 1024 && ++unitIndex)
      n = n/1024;
  return(n.toFixed(n >= 10 || unitIndex < 1 ? 0 : 2) + ' ' + units[unitIndex]);
}

function createDict(keys, values) {
    var d = {}
    for(var i=0; i<keys.length; i++) {
      d[keys[i]] = values[i];
    }
    return d;
}
const BOOK_KEYS = ["id", "name", "path", "url", "size", "description", "title", "tags", "date", "favicon", "faviconMimeType", "downloadId"];
function addBook(values) {
  var b = createDict(BOOK_KEYS, values);
  if (b.downloadId && !downloadUpdaters.hasOwnProperty(b.id)) {
    downloadUpdaters[b.id] = setInterval(function() { getDownloadInfo(b.id); }, 1000);
  }
  app.books.push(b);
}
function onBooksChanged () {
  app.books = [];
  for(var i=contentManager.startBookIndex; i<contentManager.endBookIndex; i++) {
    var id = library.bookIds[i];
    library.getBookInfos(id, BOOK_KEYS, addBook);
  }
}

downloadUpdaters = {}
const DOWNLOAD_KEYS = ["id", "status", "followedBy", "path", "totalLength", "completedLength", "downloadSpeed", "verifiedLength"];
function getDownloadInfo(id) {
  downloader.updateDownloadInfos(id, DOWNLOAD_KEYS, function(values) {
    if (values.length == 0) {
      clearInterval(downloadUpdaters[id]);
      return;
    }
    d = createDict(DOWNLOAD_KEYS, values);
    if (d.status == "completed") {
      clearInterval(downloadUpdaters[id]);
    }
    Vue.set(app.downloads, id, createDict(DOWNLOAD_KEYS, values));
  });
}

function init() {
  new QWebChannel(qt.webChannelTransport, function(channel) {
    contentManager = channel.objects.contentManager;
    library = channel.objects.library;
    kiwix = channel.objects.kiwix;
    downloader = channel.objects.downloader;
    app = new Vue({
      el: "#app",
      data: {
        contentManager: contentManager,
        library: library,
        kiwix: kiwix,
        downloader: downloader,
        books: [],
        downloads: {}
      },
      methods: {
        openBook : function(book) {
          kiwix.openUrl("zim://"+book.id+".zim/", true, function() {});
        },
        changePage : function(delta) {
          var newPage = contentManager.currentPage+delta;
          if (newPage < 0) newPage = 0;
          if (newPage > contentManager.nbPages) newPage = contentManager.nbPages;
          contentManager.currentPage = newPage;
        },
        downloadBook : function(book) {
          downloader.downloadBook(book.id, function(did)  {
            book.downloadId = did;
            downloadUpdaters[book.id] = setInterval(function() { getDownloadInfo(book.id); }, 1000);
          });
        },
        niceBytes : niceBytes
      }
    });
    library.booksChanged.connect(onBooksChanged);
    contentManager.pagingChanged.connect(onBooksChanged);
    onBooksChanged();
  });
}
</script>
<style>
#app {
    display: flex;
}
</style>
</head>
<body onload="init()">
<div id="app">
  <div id="sideBar">
  <ul>
    <li><a>All files</a></li>
    <li><a>Local files</a></li>
    <li><a>Browse by category</a></li>
    <li><a>Language:</a></li>
    <li><a>Content type:</a></li>
  </ul>
  </div>
  <div>
   <div id="searchBar">
     <form>
       <input />
     </form>
   </div>
   <div id="bookList">
     <div class="header">
       <span>File name</span><span>Size</span><span>Date</span><span>Content type</span>
     </div>
     <ul>
       <li v-for="book in books">
         <div class="book header">
           <span>
             <img v-bind:src="'data:image/png;base64,' + book.favicon"/> {{ book.title }}
           </span>
           <span>
             {{ niceBytes(book.size) }}
           </span>
           <span>
             {{ book.date }}
           </span>
           <span>
             {{ book.tags }}
           </span>
           <span>
             <template v-if="book.downloadId">
               <span v-if="downloads[book.id]">
                 {{ niceBytes(downloads[book.id].completedLength) }} / {{ niceBytes(downloads[book.id].totalLength) }}
               </span>
             </template>
             <button v-else-if="book.path" v-on:click="openBook(book)">Open</button>
             <button v-else v-on:click="downloadBook(book)">Download ({{niceBytes(book.size)}})</button>
           </span>
         </div>
         <div class="book content">
           {{ book.description }}
         </div>
       </li>
     </ul>
     <div class="footer">
       <button v-on:click="contentManager.currentPage = 0">First</button>
       <button v-on:click="changePage(-1)">Previous</button>
       {{ contentManager.currentPage+1 }} / {{ contentManager.nbPages+1 }}
       <button v-on:click="changePage(1)">Next</button>
       <button v-on:click="contentManager.currentPage = contentManager.nbPages">Last</button>
     </div>
   </div>
 </div>
</div>
</body></html>
